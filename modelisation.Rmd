---
title: "Modélisation mémoire"
author: "Degives Nicolas"
date: "2023"
output:
  html_document:
    code_folding: show
    collapsed: yes
    fig_caption: yes
    fig_height: 5
    fig_width: 6
    highlight: tango
    number_sections: yes
    smart: no
    theme: united
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
    number_sections: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list = ls())
library(tidyverse)
library(data.table)
setwd("C:/Nico/Github/Memoire")
source("ArchiSimple/src/io_archisimple.R")
```

# Fonction pour run le modèle

```{r, echo=TRUE}
ArchiSimple <- function(par,exporttype,time) {
  setwd("ArchiSimple/src/archisimple93/")
  inc <-0
  for (variety in par$exportName) {
    # Print l'avancé de la boucle
    inc <- inc+1
    print(paste("Simulation pour :", variety, "i=", inc, '========================'))
    
    
    #Update les paramètres
      ## Regarde chaque colone de params, si la même est dans par, il remplace la colonne de params par celle de par
    params <- params %>%
      mutate(across(everything(), ~ ifelse(cur_column() %in% names(par), par[inc,][[cur_column()]],.))) %>%
      mutate(exportType = exporttype) %>%
      mutate(simtime=time)
    print(params)
    # Créaction du fichier paramètre lu par ArchiSimple
    write_archisimple_XML(params, path = "parameter.xml")
    
    # Run ArchiSimple
    system("./archisimple")
  }
  setwd("../../../")
}
```

# Sorgho

## Choix des valeurs de paramètres

Importe le fichier 'base_parameter.xml' ainsi qu'un dataframe avec les valeurs qui doivent être modifiées.

```{r, echo=TRUE}
# Import des paramètres de base
params <- read_archisimple_xml("base_parameter.xml")

# Insérer les différents paramètres à modifier dans le batch
par_sorgho <- data.frame(
    exportName=c('Amiggo','Biggben','Hyperion','Juno','Swingg','Vegga'),
    dmin=c(      0.1567  ,0.1567  ,0.1567   ,0.1567  ,0.1567  ,0.1297),
    RDM = c(     0.1874  ,0.2022  ,0.228    ,0.17545 ,0.1745  ,0.1611)
  )
```

## Run le modèle .txt

```{r, echo=TRUE}
ArchiSimple(par=par_sorgho,exporttype = 1,time = 40)
```

### Résultats de la modélisation

```{r, echo=TRUE}
setwd("ArchiSimple/src/archisimple93/")
sims <- NULL
for (variety in c('Amiggo','Biggben','Hyperion','Juno','Swingg','Vegga')) {
  rs <- fread(paste0(variety,'.txt')) %>%
    mutate(sim = as.factor(variety))
  sims <- rbind(sims,rs)
}
setwd("../../../") 
```

#### Plot en fonction du diamètre

```{r, echo=TRUE}
for (variety in levels(sims$sim)) {
  print(
    subset(sims,sim==variety) %>%
      ggplot() +
      theme_classic() +
      geom_segment(aes(x = X1, y = -Z1, xend = X2, yend = -Z2, color=Diam), alpha=0.9) +
      scale_color_gradient(low = "blue", high = "red") +
      coord_fixed()+
      labs(title=variety,col='Diamètre')
    )
}
```

## Run le modèle .RSML

```{r, echo=TRUE}
ArchiSimple(par=par_sorgho,exporttype = 2,time = 40)
```

### Résultats de la modélisation

#### Plot en fonction de l'age

```{r, echo=TRUE}
archiDART::archidraw(inputrsml = 'ArchiSimple/src/archisimple93/', rsml.date="age", coldate=rainbow(15), lwd=2, twod=c("x", "y"), asp=1, las=1, bty="l")

```

#### Chiffre

La fonction archiDART::root donne les attributs de chaque racine.

```{r, echo=TRUE}
roots <- archiDART::rsmlToTable('ArchiSimple/src/archisimple93/')
r <- archiDART::root(roots)
```

# Maize

## Choix des valeurs de paramètre

```{r, echo=TRUE}
params_maize <- data.frame(
  ageAdv = 7,
  CVDD = 0.3,
  dAdv = 1,
  distAdv = 20,
  dmax = ,
  dmin = 0.14,
  dSem = 1,
  EL =  51,
  erAdv = 0.8,
  erSem =  0.5,
  exportName = 'maize' ,
  exportType = 1,
  GDs = 50,
  IPD =  2,
  LDC =  3000,
  maxAdv = 40,
  maxSem =  5,
  pdmax =  0.8,
  pdmin =  0,
  PDT = 4.5,
  RDM =  0.12,
  SGC =  0,
  sim_length = 20,
  simtime =  20,
  TMD =  0.08,
  TrInt = 0.01,
  TrT = 1 
)
```

## Run le modèle .txt

```{r, echo=TRUE}
ArchiSimple(par=par_sorgho,exporttype = 1,time = 40)
```

### Résultats de la modélisation

```{r, echo=TRUE}
setwd("ArchiSimple/src/archisimple93/")
maize <- fread('maize.txt') %>%
  mutate(sim='maize')
setwd("../../../") 
```

#### Plot en fonction du diamètre

```{r, echo=TRUE}
maize %>%
      ggplot() +
      theme_classic() +
      geom_segment(aes(x = X1, y = -Z1, xend = X2, yend = -Z2, color=Diam), alpha=0.9) +
      scale_color_gradient(low = "blue", high = "red") +
      coord_fixed()+
      labs(title='Maize')
```

### Plot en fonction de l'age

Le plot et l'importation des données est déjà fait avant.

```{r, echo=TRUE}
 
```

```{r, echo=TRUE}
 
```

```{r, echo=TRUE}
 
```